<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Projeção Financeira</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 10px;
            backdrop-filter: blur(10px);
        }

        .nav-tab {
            background: transparent;
            border: none;
            padding: 12px 20px;
            margin: 0 5px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
        }

        .nav-tab.active {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .content-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .stat-card.cartao {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .receita { color: #28a745; font-weight: 600; }
        .despesa { color: #dc3545; font-weight: 600; }
        .cartao { color: #ff6b6b; font-weight: 600; }
        .neutro { color: #333; font-weight: 600; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            margin-top: -10px;
        }

        .close:hover {
            color: #333;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            border-left: 5px solid;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .cartao-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e1e5e9;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .cartao-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .cartao-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cartao-nome {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .cartao-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .cartao-info-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .cartao-info-item strong {
            display: block;
            color: #667eea;
            margin-bottom: 5px;
        }

        .fatura-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .fatura-atual { 
            background: #d4edda; 
            color: #155724; 
        }

        .fatura-futura { 
            background: #cce7ff; 
            color: #004085; 
        }

        .fatura-passada { 
            background: #f8f9fa; 
            color: #6c757d; 
        }

        .periodo-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .periodo-selector select {
            min-width: 120px;
        }

        .resumo-cartoes {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .resumo-cartoes h4 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .resumo-cartoes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .resumo-cartao-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .resumo-cartao-item strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .resumo-cartao-item span {
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-tab {
                margin-bottom: 5px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .cartao-info {
                grid-template-columns: 1fr;
            }

            .periodo-selector {
                flex-direction: column;
                align-items: stretch;
            }

            .resumo-cartoes-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💰 Sistema de Projeção Financeira</h1>
            <p>Controle completo das suas finanças pessoais</p>
        </div>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('configuracao')">⚙️ Configuração</button>
            <button class="nav-tab" onclick="showSection('dashboard')">📊 Dashboard</button>
            <button class="nav-tab" onclick="showSection('receitas')">💚 Receitas</button>
            <button class="nav-tab" onclick="showSection('despesas')">💸 Despesas</button>
            <button class="nav-tab" onclick="showSection('cartoes')">💳 Cartões</button>
            <button class="nav-tab" onclick="showSection('relatorios')">📈 Relatórios</button>
            <button class="nav-tab" onclick="showSection('backup')">💾 Backup</button>
        </nav>

        <!-- SEÇÃO CONFIGURAÇÃO -->
        <div id="configuracao" class="content-section active">
            <div class="card">
                <h3>⚙️ Configuração Inicial do Sistema</h3>
                <div id="configStatus" class="alert alert-warning">
                    ⚠️ Sistema não configurado. Configure os dados iniciais para começar.
                </div>
                
                <div class="form-group">
                    <label for="mesInicio">Mês de Início</label>
                    <select id="mesInicio">
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="anoInicio">Ano de Início</label>
                    <input type="number" id="anoInicio" min="2020" max="2030" value="2025">
                </div>

                <div class="form-group">
                    <label for="saldoInicial">Saldo Inicial (R$)</label>
                    <input type="number" id="saldoInicial" step="0.01" placeholder="0.00">
                </div>

                <button class="btn" onclick="configurarSistema()">💾 Configurar Sistema</button>
                <button class="btn btn-danger" onclick="resetarSistema()">🔄 Resetar Sistema</button>
            </div>
        </div>

        <!-- SEÇÃO DASHBOARD -->
        <div id="dashboard" class="content-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalReceitas">R$ 0,00</h3>
                    <p>Total Receitas</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalDespesas">R$ 0,00</h3>
                    <p>Total Despesas</p>
                </div>
                <div class="stat-card cartao">
                    <h3 id="totalCartoes">R$ 0,00</h3>
                    <p>Faturas Cartões</p>
                </div>
                <div class="stat-card">
                    <h3 id="saldoFinal">R$ 0,00</h3>
                    <p>Saldo Final</p>
                </div>
            </div>

            <div class="card">
                <h3>📊 Resumo Mensal</h3>
                <div class="form-group">
                    <label for="dashboardMes">Selecionar Mês</label>
                    <select id="dashboardMes" onchange="atualizarDashboard()">
                        <!-- Opções geradas dinamicamente -->
                    </select>
                </div>

                <div id="resumoCartoesDashboard"></div>

                <div class="table-container">
                    <table id="tabelaDashboard">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados gerados dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SEÇÃO RECEITAS -->
        <div id="receitas" class="content-section">
            <div class="card">
                <h3>💚 Gestão de Receitas</h3>
                
                <div class="form-group">
                    <label for="tipoReceitaNovo">Novo Tipo de Receita</label>
                    <input type="text" id="tipoReceitaNovo" placeholder="Ex: Salário, Freelance, etc.">
                    <button class="btn" onclick="adicionarTipoReceita()">➕ Adicionar Tipo</button>
                </div>

                <div class="form-group">
                    <label for="tipoReceita">Tipo de Receita</label>
                    <select id="tipoReceita">
                        <option value="">Selecione um tipo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="valorReceita">Valor (R$)</label>
                    <input type="number" id="valorReceita" step="0.01" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="mesReceita">Mês de Referência</label>
                    <select id="mesReceita">
                        <!-- Opções geradas dinamicamente -->
                    </select>
                </div>

                <button class="btn" onclick="adicionarReceita()">💰 Adicionar Receita</button>
                <button class="btn btn-secondary" onclick="mostrarLancamentoMassa('receita')">📊 Lançamento em Massa</button>
            </div>

            <div class="card">
                <h3>📋 Receitas Cadastradas</h3>
                <div class="table-container">
                    <table id="tabelaReceitas">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Mês</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados gerados dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SEÇÃO DESPESAS -->
        <div id="despesas" class="content-section">
            <div class="card">
                <h3>💸 Gestão de Despesas</h3>
                
                <div class="form-group">
                    <label for="tipoDespesaNovo">Novo Tipo de Despesa</label>
                    <input type="text" id="tipoDespesaNovo" placeholder="Ex: Aluguel, Alimentação, etc.">
                    <button class="btn" onclick="adicionarTipoDespesa()">➕ Adicionar Tipo</button>
                </div>

                <div class="form-group">
                    <label for="tipoDespesa">Tipo de Despesa</label>
                    <select id="tipoDespesa">
                        <option value="">Selecione um tipo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="valorDespesa">Valor (R$)</label>
                    <input type="number" id="valorDespesa" step="0.01" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="mesDespesa">Mês de Referência</label>
                    <select id="mesDespesa">
                        <!-- Opções geradas dinamicamente -->
                    </select>
                </div>

                <button class="btn" onclick="adicionarDespesa()">💳 Adicionar Despesa</button>
                <button class="btn btn-secondary" onclick="mostrarLancamentoMassa('despesa')">📊 Lançamento em Massa</button>
            </div>

            <div class="card">
                <h3>📋 Despesas Cadastradas</h3>
                <div class="table-container">
                    <table id="tabelaDespesas">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Mês</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados gerados dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SEÇÃO CARTÕES -->
        <div id="cartoes" class="content-section">
            <div class="card">
                <h3>💳 Cadastro de Cartões</h3>
                
                <div class="form-group">
                    <label for="nomeCartao">Nome do Cartão</label>
                    <input type="text" id="nomeCartao" placeholder="Ex: Nubank, Inter, etc.">
                </div>

                <div class="form-group">
                    <label for="vencimentoCartao">Dia do Vencimento</label>
                    <input type="number" id="vencimentoCartao" min="1" max="31" placeholder="Ex: 15">
                </div>

                <div class="form-group">
                    <label for="melhorDiaCartao">Melhor Dia para Compra</label>
                    <input type="number" id="melhorDiaCartao" min="1" max="31" placeholder="Ex: 18">
                </div>

                <button class="btn" onclick="cadastrarCartao()">💳 Cadastrar Cartão</button>
            </div>

            <div class="card">
                <h3>🛒 Registrar Compra</h3>
                
                <div class="form-group">
                    <label for="cartaoCompra">Cartão</label>
                    <select id="cartaoCompra">
                        <option value="">Selecione um cartão</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="descricaoCompra">Descrição da Compra</label>
                    <input type="text" id="descricaoCompra" placeholder="Ex: Supermercado, Gasolina, etc.">
                </div>

                <div class="form-group">
                    <label for="valorCompra">Valor (R$)</label>
                    <input type="number" id="valorCompra" step="0.01" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="dataCompra">Data da Compra</label>
                    <input type="date" id="dataCompra">
                </div>

                <button class="btn" onclick="registrarCompra()">🛒 Registrar Compra</button>
            </div>

            <div class="card">
                <h3>📋 Meus Cartões</h3>
                <div id="listaCartoes">
                    <!-- Cartões gerados dinamicamente -->
                </div>
            </div>
        </div>

        <!-- SEÇÃO RELATÓRIOS -->
        <div id="relatorios" class="content-section">
            <div class="card">
                <h3>📈 Relatórios Anuais</h3>
                
                <div class="form-group">
                    <label for="anoRelatorio">Ano do Relatório</label>
                    <select id="anoRelatorio" onchange="gerarRelatorioAnual()">
                        <!-- Opções geradas dinamicamente -->
                    </select>
                </div>

                <div class="table-container">
                    <table id="tabelaRelatorio">
                        <thead>
                            <tr>
                                <th>Mês</th>
                                <th>Receitas</th>
                                <th>Despesas</th>
                                <th>Cartões</th>
                                <th>Saldo Mensal</th>
                                <th>Saldo Acumulado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados gerados dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SEÇÃO BACKUP -->
        <div id="backup" class="content-section">
            <div class="card">
                <h3>💾 Backup e Restauração</h3>
                
                <div class="form-group">
                    <button class="btn btn-success" onclick="exportarDados()">📤 Exportar Dados</button>
                    <p>Baixe um arquivo JSON com todos os seus dados financeiros</p>
                </div>

                <div class="form-group">
                    <label for="arquivoImport">Importar Dados</label>
                    <input type="file" id="arquivoImport" accept=".json" onchange="importarDados(event)">
                    <p>Selecione um arquivo JSON válido para restaurar seus dados</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL COMPRAS DO CARTÃO -->
    <div id="modalCompras" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalCompras()">&times;</span>
            <h2 id="modalTitulo">💳 Compras do Cartão</h2>
            
            <div class="periodo-selector">
                <div class="form-group">
                    <label for="modalAno">Ano:</label>
                    <select id="modalAno" onchange="atualizarModalCompras()">
                        <!-- Opções geradas dinamicamente -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="modalMes">Mês:</label>
                    <select id="modalMes" onchange="atualizarModalCompras()">
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
            </div>

            <div id="statusFatura" class="fatura-status">
                <!-- Status gerado dinamicamente -->
            </div>

            <div id="estatisticasFatura" style="margin-bottom: 20px;">
                <!-- Estatísticas geradas dinamicamente -->
            </div>

            <div class="table-container">
                <table id="tabelaModalCompras">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Valor</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados gerados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL LANÇAMENTO EM MASSA -->
    <div id="modalMassa" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalMassa()">&times;</span>
            <h2 id="tituloModalMassa">📊 Lançamento em Massa</h2>
            
            <div class="form-group">
                <label for="tipoMassa">Tipo</label>
                <select id="tipoMassa">
                    <!-- Opções geradas dinamicamente -->
                </select>
            </div>

            <div class="form-group">
                <label for="valorMassa">Valor (R$)</label>
                <input type="number" id="valorMassa" step="0.01" placeholder="0.00">
            </div>

            <div class="form-group">
                <label>Selecionar Meses</label>
                <div id="checkboxesMeses">
                    <!-- Checkboxes gerados dinamicamente -->
                </div>
            </div>

            <button class="btn" onclick="executarLancamentoMassa()">📊 Executar Lançamento</button>
        </div>
    </div>

    <script>
        // VARIÁVEIS GLOBAIS
        let dadosSistema = {
            configuracao: null,
            tiposReceita: [],
            tiposDespesa: [],
            receitas: {},
            despesas: {},
            cartoes: [],
            comprasCartao: {},
            versao: "3.1"
        };

        let sistemaConfigurado = false;
        let cartaoModalAtual = null;

        // FUNÇÕES UTILITÁRIAS
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function formatarMes(mes, ano) {
            const meses = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return `${meses[mes - 1]}/${ano}`;
        }

        function chaveAnoMes(ano, mes) {
            return `${ano}-${mes.toString().padStart(2, '0')}`;
        }

        // NAVEGAÇÃO
        function showSection(sectionId) {
            // Esconder todas as seções
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remover classe active de todas as abas
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar seção selecionada
            document.getElementById(sectionId).classList.add('active');

            // Ativar aba correspondente
            event.target.classList.add('active');

            // Atualizar dados específicos da seção
            switch(sectionId) {
                case 'dashboard':
                    atualizarDashboard();
                    break;
                case 'receitas':
                    atualizarListaReceitas();
                    break;
                case 'despesas':
                    atualizarListaDespesas();
                    break;
                case 'cartoes':
                    atualizarListaCartoes();
                    break;
                case 'relatorios':
                    gerarRelatorioAnual();
                    break;
            }
        }

        // CONFIGURAÇÃO DO SISTEMA
        function configurarSistema() {
            const mesInicio = parseInt(document.getElementById('mesInicio').value);
            const anoInicio = parseInt(document.getElementById('anoInicio').value);
            const saldoInicial = parseFloat(document.getElementById('saldoInicial').value) || 0;

            dadosSistema.configuracao = {
                mesInicio,
                anoInicio,
                saldoInicial,
                dataConfiguracao: new Date().toISOString()
            };

            sistemaConfigurado = true;

            // Atualizar interface
            document.getElementById('configStatus').innerHTML = 
                `<div class="alert alert-success">✅ Sistema configurado! Início: ${formatarMes(mesInicio, anoInicio)} | Saldo inicial: ${formatarMoeda(saldoInicial)}</div>`;

            // Gerar opções de meses
            gerarOpcoesMeses();
            
            salvarDados();
            alert('✅ Sistema configurado com sucesso!');
        }

        function resetarSistema() {
            if (confirm('⚠️ Isso apagará todos os dados. Tem certeza?')) {
                localStorage.removeItem('sistemaFinanceiro');
                dadosSistema = {
                    configuracao: null,
                    tiposReceita: [],
                    tiposDespesa: [],
                    receitas: {},
                    despesas: {},
                    cartoes: [],
                    comprasCartao: {},
                    versao: "3.1"
                };
                sistemaConfigurado = false;
                location.reload();
            }
        }

        function gerarOpcoesMeses() {
            if (!sistemaConfigurado) return;

            const config = dadosSistema.configuracao;
            const anoAtual = new Date().getFullYear();
            const meses = [];

            // Gerar meses de início até 2 anos no futuro
            for (let ano = config.anoInicio; ano <= anoAtual + 2; ano++) {
                const mesInicial = (ano === config.anoInicio) ? config.mesInicio : 1;
                const mesFinal = 12;

                for (let mes = mesInicial; mes <= mesFinal; mes++) {
                    meses.push({ ano, mes, chave: chaveAnoMes(ano, mes), label: formatarMes(mes, ano) });
                }
            }

            // Atualizar selects
            const selects = ['mesReceita', 'mesDespesa', 'dashboardMes', 'anoRelatorio'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    if (selectId === 'anoRelatorio') {
                        // Para relatório, só anos
                        select.innerHTML = '';
                        const anos = [...new Set(meses.map(m => m.ano))];
                        anos.forEach(ano => {
                            select.innerHTML += `<option value="${ano}">${ano}</option>`;
                        });
                    } else {
                        // Para outros, meses completos
                        select.innerHTML = '';
                        meses.forEach(mes => {
                            select.innerHTML += `<option value="${mes.chave}">${mes.label}</option>`;
                        });
                    }
                }
            });
        }

        // GESTÃO DE TIPOS
        function adicionarTipoReceita() {
            const nome = document.getElementById('tipoReceitaNovo').value.trim();
            if (!nome) {
                alert('⚠️ Digite um nome para o tipo de receita');
                return;
            }

            const novoTipo = {
                id: generateId(),
                nome,
                dataCriacao: new Date().toISOString()
            };

            dadosSistema.tiposReceita.push(novoTipo);
            document.getElementById('tipoReceitaNovo').value = '';
            
            atualizarSelectsTipos();
            salvarDados();
            alert(`✅ Tipo "${nome}" adicionado com sucesso!`);
        }

        function adicionarTipoDespesa() {
            const nome = document.getElementById('tipoDespesaNovo').value.trim();
            if (!nome) {
                alert('⚠️ Digite um nome para o tipo de despesa');
                return;
            }

            const novoTipo = {
                id: generateId(),
                nome,
                dataCriacao: new Date().toISOString()
            };

            dadosSistema.tiposDespesa.push(novoTipo);
            document.getElementById('tipoDespesaNovo').value = '';
            
            atualizarSelectsTipos();
            salvarDados();
            alert(`✅ Tipo "${nome}" adicionado com sucesso!`);
        }

        function atualizarSelectsTipos() {
            // Atualizar select de receitas
            const selectReceita = document.getElementById('tipoReceita');
            selectReceita.innerHTML = '<option value="">Selecione um tipo</option>';
            dadosSistema.tiposReceita.forEach(tipo => {
                selectReceita.innerHTML += `<option value="${tipo.id}">${tipo.nome}</option>`;
            });

            // Atualizar select de despesas
            const selectDespesa = document.getElementById('tipoDespesa');
            selectDespesa.innerHTML = '<option value="">Selecione um tipo</option>';
            dadosSistema.tiposDespesa.forEach(tipo => {
                selectDespesa.innerHTML += `<option value="${tipo.id}">${tipo.nome}</option>`;
            });
        }

        // GESTÃO DE RECEITAS
        function adicionarReceita() {
            if (!sistemaConfigurado) {
                alert('⚠️ Configure o sistema primeiro na aba Configuração');
                return;
            }

            const tipoId = document.getElementById('tipoReceita').value;
            const valor = parseFloat(document.getElementById('valorReceita').value);
            const mesChave = document.getElementById('mesReceita').value;

            if (!tipoId || !valor || !mesChave) {
                alert('⚠️ Preencha todos os campos');
                return;
            }

            const tipo = dadosSistema.tiposReceita.find(t => t.id === tipoId);
            const novaReceita = {
                id: generateId(),
                tipoId,
                tipoNome: tipo.nome,
                valor,
                mesChave,
                dataCriacao: new Date().toISOString()
            };

            if (!dadosSistema.receitas[mesChave]) {
                dadosSistema.receitas[mesChave] = [];
            }
            dadosSistema.receitas[mesChave].push(novaReceita);

            // Limpar formulário
            document.getElementById('tipoReceita').value = '';
            document.getElementById('valorReceita').value = '';

            salvarDados();
            atualizarListaReceitas();
            alert(`✅ Receita de ${formatarMoeda(valor)} adicionada!`);
        }

        function atualizarListaReceitas() {
            const tbody = document.querySelector('#tabelaReceitas tbody');
            tbody.innerHTML = '';

            Object.keys(dadosSistema.receitas).forEach(mesChave => {
                dadosSistema.receitas[mesChave].forEach(receita => {
                    const [ano, mes] = mesChave.split('-');
                    tbody.innerHTML += `
                        <tr>
                            <td>${receita.tipoNome}</td>
                            <td class="receita">${formatarMoeda(receita.valor)}</td>
                            <td>${formatarMes(parseInt(mes), parseInt(ano))}</td>
                            <td>
                                <button class="btn btn-danger" onclick="excluirReceita('${mesChave}', '${receita.id}')">🗑️</button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        function excluirReceita(mesChave, receitaId) {
            if (confirm('⚠️ Tem certeza que deseja excluir esta receita?')) {
                dadosSistema.receitas[mesChave] = dadosSistema.receitas[mesChave].filter(r => r.id !== receitaId);
                if (dadosSistema.receitas[mesChave].length === 0) {
                    delete dadosSistema.receitas[mesChave];
                }
                salvarDados();
                atualizarListaReceitas();
            }
        }

        // GESTÃO DE DESPESAS
        function adicionarDespesa() {
            if (!sistemaConfigurado) {
                alert('⚠️ Configure o sistema primeiro na aba Configuração');
                return;
            }

            const tipoId = document.getElementById('tipoDespesa').value;
            const valor = parseFloat(document.getElementById('valorDespesa').value);
            const mesChave = document.getElementById('mesDespesa').value;

            if (!tipoId || !valor || !mesChave) {
                alert('⚠️ Preencha todos os campos');
                return;
            }

            const tipo = dadosSistema.tiposDespesa.find(t => t.id === tipoId);
            const novaDespesa = {
                id: generateId(),
                tipoId,
                tipoNome: tipo.nome,
                valor,
                mesChave,
                dataCriacao: new Date().toISOString()
            };

            if (!dadosSistema.despesas[mesChave]) {
                dadosSistema.despesas[mesChave] = [];
            }
            dadosSistema.despesas[mesChave].push(novaDespesa);

            // Limpar formulário
            document.getElementById('tipoDespesa').value = '';
            document.getElementById('valorDespesa').value = '';

            salvarDados();
            atualizarListaDespesas();
            alert(`✅ Despesa de ${formatarMoeda(valor)} adicionada!`);
        }

        function atualizarListaDespesas() {
            const tbody = document.querySelector('#tabelaDespesas tbody');
            tbody.innerHTML = '';

            Object.keys(dadosSistema.despesas).forEach(mesChave => {
                dadosSistema.despesas[mesChave].forEach(despesa => {
                    const [ano, mes] = mesChave.split('-');
                    tbody.innerHTML += `
                        <tr>
                            <td>${despesa.tipoNome}</td>
                            <td class="despesa">${formatarMoeda(despesa.valor)}</td>
                            <td>${formatarMes(parseInt(mes), parseInt(ano))}</td>
                            <td>
                                <button class="btn btn-danger" onclick="excluirDespesa('${mesChave}', '${despesa.id}')">🗑️</button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        function excluirDespesa(mesChave, despesaId) {
            if (confirm('⚠️ Tem certeza que deseja excluir esta despesa?')) {
                dadosSistema.despesas[mesChave] = dadosSistema.despesas[mesChave].filter(d => d.id !== despesaId);
                if (dadosSistema.despesas[mesChave].length === 0) {
                    delete dadosSistema.despesas[mesChave];
                }
                salvarDados();
                atualizarListaDespesas();
            }
        }

        // FUNÇÕES PARA CARTÕES
        function cadastrarCartao() {
            if (!sistemaConfigurado) {
                alert('⚠️ Configure o sistema primeiro na aba Configuração');
                return;
            }

            const nome = document.getElementById('nomeCartao').value.trim();
            const vencimento = parseInt(document.getElementById('vencimentoCartao').value);
            const melhorDia = parseInt(document.getElementById('melhorDiaCartao').value);

            // Validações
            if (!nome) {
                alert('⚠️ Digite um nome para o cartão');
                return;
            }

            if (!vencimento || vencimento < 1 || vencimento > 31) {
                alert('⚠️ Digite um dia válido para vencimento (1 a 31)');
                return;
            }

            if (!melhorDia || melhorDia < 1 || melhorDia > 31) {
                alert('⚠️ Digite um dia válido para melhor dia de compra (1 a 31)');
                return;
            }

            // Verificar se já existe cartão com mesmo nome
            if (dadosSistema.cartoes.find(c => c.nome.toLowerCase() === nome.toLowerCase())) {
                alert('⚠️ Já existe um cartão com este nome');
                return;
            }

            // Criar novo cartão
            const novoCartao = {
                id: generateId(),
                nome,
                vencimento,
                melhorDia,
                dataCriacao: new Date().toISOString()
            };

            dadosSistema.cartoes.push(novoCartao);
            
            // Limpar formulário
            document.getElementById('nomeCartao').value = '';
            document.getElementById('vencimentoCartao').value = '';
            document.getElementById('melhorDiaCartao').value = '';

            salvarDados();
            atualizarListaCartoes();
            atualizarSelectCartoes();
            alert(`✅ Cartão "${nome}" cadastrado com sucesso!`);
        }

        function atualizarSelectCartoes() {
            const select = document.getElementById('cartaoCompra');
            select.innerHTML = '<option value="">Selecione um cartão</option>';
            
            dadosSistema.cartoes.forEach(cartao => {
                select.innerHTML += `<option value="${cartao.id}">${cartao.nome}</option>`;
            });
        }

        function registrarCompra() {
            if (!sistemaConfigurado) {
                alert('⚠️ Configure o sistema primeiro na aba Configuração');
                return;
            }

            const cartaoId = document.getElementById('cartaoCompra').value;
            const descricao = document.getElementById('descricaoCompra').value.trim();
            const valor = parseFloat(document.getElementById('valorCompra').value);
            const dataCompra = document.getElementById('dataCompra').value;

            // Validações
            if (!cartaoId) {
                alert('⚠️ Selecione um cartão');
                return;
            }

            if (!descricao) {
                alert('⚠️ Digite uma descrição para a compra');
                return;
            }

            if (!valor || valor <= 0) {
                alert('⚠️ Digite um valor válido');
                return;
            }

            if (!dataCompra) {
                alert('⚠️ Selecione a data da compra');
                return;
            }

            // Buscar dados do cartão
            const cartao = dadosSistema.cartoes.find(c => c.id === cartaoId);
            if (!cartao) {
                alert('❌ Cartão não encontrado');
                return;
            }

            // Calcular qual fatura esta compra pertence
            const mesVencimento = calcularMesVencimento(dataCompra, cartao.melhorDia, cartao.vencimento);

            // Criar nova compra
            const novaCompra = {
                id: generateId(),
                cartaoId,
                cartaoNome: cartao.nome,
                descricao,
                valor,
                dataCompra,
                mesVencimento,
                dataCriacao: new Date().toISOString()
            };

            // Adicionar compra ao sistema
            if (!dadosSistema.comprasCartao[cartaoId]) {
                dadosSistema.comprasCartao[cartaoId] = [];
            }
            dadosSistema.comprasCartao[cartaoId].push(novaCompra);

            // Limpar formulário
            document.getElementById('descricaoCompra').value = '';
            document.getElementById('valorCompra').value = '';
            document.getElementById('dataCompra').value = new Date().toISOString().split('T')[0];

            salvarDados();
            atualizarListaCartoes();
            alert(`✅ Compra de ${formatarMoeda(valor)} registrada no cartão ${cartao.nome}!`);
        }

        function calcularMesVencimento(dataCompra, melhorDia, vencimento) {
            const data = new Date(dataCompra + 'T00:00:00');
            const diaCompra = data.getDate();
            let mesVencimento = data.getMonth() + 1;
            let anoVencimento = data.getFullYear();

            // Se a compra foi feita a partir do melhor dia, vai para próxima fatura
            if (diaCompra >= melhorDia) {
                mesVencimento++;
                if (mesVencimento > 12) {
                    mesVencimento = 1;
                    anoVencimento++;
                }
            }

            return chaveAnoMes(anoVencimento, mesVencimento);
        }

        function calcularFaturasCartoes(mesChave) {
            const faturas = {};
            
            dadosSistema.cartoes.forEach(cartao => {
                const compras = dadosSistema.comprasCartao[cartao.id] || [];
                const comprasFatura = compras.filter(c => c.mesVencimento === mesChave);
                const totalFatura = comprasFatura.reduce((sum, c) => sum + c.valor, 0);
                
                if (totalFatura > 0) {
                    faturas[cartao.id] = {
                        nome: cartao.nome,
                        total: totalFatura,
                        quantidade: comprasFatura.length,
                        compras: comprasFatura
                    };
                }
            });
            
            return faturas;
        }

        function atualizarListaCartoes() {
            const container = document.getElementById('listaCartoes');
            container.innerHTML = '';

            if (dadosSistema.cartoes.length === 0) {
                container.innerHTML = '<p>Nenhum cartão cadastrado ainda.</p>';
                return;
            }

            dadosSistema.cartoes.forEach(cartao => {
                const compras = dadosSistema.comprasCartao[cartao.id] || [];
                const totalCompras = compras.reduce((sum, compra) => sum + compra.valor, 0);
                const quantidadeCompras = compras.length;

                // Calcular fatura atual
                const hoje = new Date();
                const mesAtual = chaveAnoMes(hoje.getFullYear(), hoje.getMonth() + 1);
                const comprasAtual = compras.filter(c => c.mesVencimento === mesAtual);
                const totalAtual = comprasAtual.reduce((sum, compra) => sum + compra.valor, 0);

                container.innerHTML += `
                    <div class="cartao-item">
                        <div class="cartao-nome">💳 ${cartao.nome}</div>
                        <div class="cartao-info">
                            <div class="cartao-info-item">
                                <strong>Vencimento</strong>
                                Dia ${cartao.vencimento}
                            </div>
                            <div class="cartao-info-item">
                                <strong>Melhor Dia</strong>
                                Dia ${cartao.melhorDia}
                            </div>
                            <div class="cartao-info-item">
                                <strong>Fatura Atual</strong>
                                ${formatarMoeda(totalAtual)}
                            </div>
                            <div class="cartao-info-item">
                                <strong>Total Histórico</strong>
                                ${formatarMoeda(totalCompras)}
                            </div>
                        </div>
                        <div>
                            <button class="btn" onclick="abrirModalCompras('${cartao.id}')">👀 Ver Compras</button>
                            <button class="btn btn-danger" onclick="excluirCartao('${cartao.id}')">🗑️ Excluir</button>
                        </div>
                    </div>
                `;
            });
        }

        function excluirCartao(cartaoId) {
            const cartao = dadosSistema.cartoes.find(c => c.id === cartaoId);
            const compras = dadosSistema.comprasCartao[cartaoId] || [];
            
            if (compras.length > 0) {
                if (!confirm(`⚠️ O cartão "${cartao.nome}" possui ${compras.length} compras registradas. Excluir mesmo assim?`)) {
                    return;
                }
            }

            // Remover cartão e suas compras
            dadosSistema.cartoes = dadosSistema.cartoes.filter(c => c.id !== cartaoId);
            delete dadosSistema.comprasCartao[cartaoId];

            salvarDados();
            atualizarListaCartoes();
            atualizarSelectCartoes();
            alert(`✅ Cartão "${cartao.nome}" excluído com sucesso!`);
        }

        function abrirModalCompras(cartaoId) {
            cartaoModalAtual = cartaoId;
            const cartao = dadosSistema.cartoes.find(c => c.id === cartaoId);
            
            document.getElementById('modalTitulo').textContent = `💳 Compras - ${cartao.nome}`;
            
            // Configurar seletores de período
            const hoje = new Date();
            const anoAtual = hoje.getFullYear();
            const mesAtual = hoje.getMonth() + 1;

            // Gerar opções de ano (2022 a 2028)
            const selectAno = document.getElementById('modalAno');
            selectAno.innerHTML = '';
            for (let ano = 2022; ano <= 2028; ano++) {
                selectAno.innerHTML += `<option value="${ano}" ${ano === anoAtual ? 'selected' : ''}>${ano}</option>`;
            }

            // Definir mês atual
            document.getElementById('modalMes').value = mesAtual;

            atualizarModalCompras();
            document.getElementById('modalCompras').style.display = 'block';
        }

        function atualizarModalCompras() {
            if (!cartaoModalAtual) return;

            const ano = parseInt(document.getElementById('modalAno').value);
            const mes = parseInt(document.getElementById('modalMes').value);
            const mesChave = chaveAnoMes(ano, mes);
            
            const cartao = dadosSistema.cartoes.find(c => c.id === cartaoModalAtual);
            const todasCompras = dadosSistema.comprasCartao[cartaoModalAtual] || [];
            const comprasPeriodo = todasCompras.filter(c => c.mesVencimento === mesChave);
            
            // Calcular status da fatura
            const hoje = new Date();
            const mesAtual = chaveAnoMes(hoje.getFullYear(), hoje.getMonth() + 1);
            
            let statusClass, statusTexto;
            if (mesChave === mesAtual) {
                statusClass = 'fatura-atual';
                statusTexto = '🟢 Fatura Atual';
            } else if (mesChave > mesAtual) {
                statusClass = 'fatura-futura';
                statusTexto = '🔵 Fatura Futura';
            } else {
                statusClass = 'fatura-passada';
                statusTexto = '⚪ Fatura Passada';
            }

            document.getElementById('statusFatura').className = `fatura-status ${statusClass}`;
            document.getElementById('statusFatura').textContent = `${statusTexto} - ${formatarMes(mes, ano)}`;

            // Calcular estatísticas
            const totalFatura = comprasPeriodo.reduce((sum, c) => sum + c.valor, 0);
            const quantidadeCompras = comprasPeriodo.length;
            const mediaCompra = quantidadeCompras > 0 ? totalFatura / quantidadeCompras : 0;

            document.getElementById('estatisticasFatura').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <strong style="color: #667eea; display: block; margin-bottom: 5px;">Total da Fatura</strong>
                        <span style="font-size: 1.2rem; font-weight: 600;">${formatarMoeda(totalFatura)}</span>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <strong style="color: #667eea; display: block; margin-bottom: 5px;">Quantidade</strong>
                        <span style="font-size: 1.2rem; font-weight: 600;">${quantidadeCompras} compras</span>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <strong style="color: #667eea; display: block; margin-bottom: 5px;">Média por Compra</strong>
                        <span style="font-size: 1.2rem; font-weight: 600;">${formatarMoeda(mediaCompra)}</span>
                    </div>
                </div>
            `;

            // Atualizar tabela
            const tbody = document.querySelector('#tabelaModalCompras tbody');
            tbody.innerHTML = '';

            if (comprasPeriodo.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #666;">Nenhuma compra registrada para este período</td></tr>';
            } else {
                comprasPeriodo
                    .sort((a, b) => new Date(b.dataCompra) - new Date(a.dataCompra))
                    .forEach(compra => {
                        const dataFormatada = new Date(compra.dataCompra + 'T00:00:00').toLocaleDateString('pt-BR');
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>${dataFormatada}</td>
                                <td>${compra.descricao}</td>
                                <td class="cartao">${formatarMoeda(compra.valor)}</td>
                                <td>
                                    <button class="btn btn-danger" onclick="excluirCompraCartao('${compra.id}')">🗑️</button>
                                </td>
                            </tr>
                        `;
                    });
            }
        }

        function excluirCompraCartao(compraId) {
            if (!confirm('⚠️ Tem certeza que deseja excluir esta compra?')) {
                return;
            }

            const cartaoId = cartaoModalAtual;
            dadosSistema.comprasCartao[cartaoId] = dadosSistema.comprasCartao[cartaoId].filter(c => c.id !== compraId);
            
            salvarDados();
            atualizarModalCompras();
            atualizarListaCartoes();
            alert('✅ Compra excluída com sucesso!');
        }

        function fecharModalCompras() {
            document.getElementById('modalCompras').style.display = 'none';
            cartaoModalAtual = null;
        }

        // DASHBOARD INTEGRADO COM CARTÕES
        function atualizarDashboard() {
            if (!sistemaConfigurado) return;

            const mesAtual = document.getElementById('dashboardMes').value;
            
            if (!mesAtual) return;

            // Calcular totais
            let totalReceitas = 0;
            let totalDespesas = 0;
            let totalCartoes = 0;

            // Receitas do mês
            if (dadosSistema.receitas[mesAtual]) {
                totalReceitas = dadosSistema.receitas[mesAtual].reduce((sum, r) => sum + r.valor, 0);
            }

            // Despesas do mês
            if (dadosSistema.despesas[mesAtual]) {
                totalDespesas = dadosSistema.despesas[mesAtual].reduce((sum, d) => sum + d.valor, 0);
            }

            // Faturas de cartão do mês
            const faturas = calcularFaturasCartoes(mesAtual);
            totalCartoes = Object.values(faturas).reduce((sum, fatura) => sum + fatura.total, 0);

            const saldoFinal = totalReceitas - totalDespesas - totalCartoes;

            // Atualizar cards
            document.getElementById('totalReceitas').textContent = formatarMoeda(totalReceitas);
            document.getElementById('totalDespesas').textContent = formatarMoeda(totalDespesas);
            document.getElementById('totalCartoes').textContent = formatarMoeda(totalCartoes);
            document.getElementById('saldoFinal').textContent = formatarMoeda(saldoFinal);

            // Atualizar resumo de cartões
            atualizarResumoCartoesDashboard(faturas);

            // Atualizar tabela
            const tbody = document.querySelector('#tabelaDashboard tbody');
            tbody.innerHTML = '';

            // Receitas
            if (dadosSistema.receitas[mesAtual]) {
                dadosSistema.receitas[mesAtual].forEach(receita => {
                    tbody.innerHTML += `
                        <tr>
                            <td>💚 Receita</td>
                            <td>${receita.tipoNome}</td>
                            <td class="receita">${formatarMoeda(receita.valor)}</td>
                            <td>-</td>
                        </tr>
                    `;
                });
            }

            // Despesas
            if (dadosSistema.despesas[mesAtual]) {
                dadosSistema.despesas[mesAtual].forEach(despesa => {
                    tbody.innerHTML += `
                        <tr>
                            <td>💸 Despesa</td>
                            <td>${despesa.tipoNome}</td>
                            <td class="despesa">${formatarMoeda(despesa.valor)}</td>
                            <td>-</td>
                        </tr>
                    `;
                });
            }

            // Faturas de cartão
            Object.values(faturas).forEach(fatura => {
                tbody.innerHTML += `
                    <tr>
                        <td>💳 Cartão</td>
                        <td>Fatura ${fatura.nome}</td>
                        <td class="cartao">${formatarMoeda(fatura.total)}</td>
                        <td>${fatura.quantidade} compras</td>
                    </tr>
                `;
            });

            if (tbody.innerHTML === '') {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px;">Nenhuma movimentação registrada para este mês</td></tr>';
            }
        }

        function atualizarResumoCartoesDashboard(faturas) {
            const container = document.getElementById('resumoCartoesDashboard');
            
            if (Object.keys(faturas).length === 0) {
                container.innerHTML = '';
                return;
            }

            let htmlResumo = `
                <div class="resumo-cartoes">
                    <h4>💳 Resumo de Cartões</h4>
                    <div class="resumo-cartoes-grid">
            `;

            Object.values(faturas).forEach(fatura => {
                const media = fatura.total / fatura.quantidade;
                htmlResumo += `
                    <div class="resumo-cartao-item">
                        <strong>${fatura.nome}</strong>
                        <span>Total: ${formatarMoeda(fatura.total)}</span>
                        <span>${fatura.quantidade} compras | Média: ${formatarMoeda(media)}</span>
                    </div>
                `;
            });

            htmlResumo += `
                    </div>
                </div>
            `;

            container.innerHTML = htmlResumo;
        }

        // RELATÓRIOS COM CARTÕES
        function gerarRelatorioAnual() {
            if (!sistemaConfigurado) return;

            const ano = document.getElementById('anoRelatorio').value;
            if (!ano) return;

            const tbody = document.querySelector('#tabelaRelatorio tbody');
            tbody.innerHTML = '';

            let saldoAcumulado = dadosSistema.configuracao.saldoInicial;

            for (let mes = 1; mes <= 12; mes++) {
                const mesChave = chaveAnoMes(parseInt(ano), mes);
                
                // Calcular receitas do mês
                let receitasMes = 0;
                if (dadosSistema.receitas[mesChave]) {
                    receitasMes = dadosSistema.receitas[mesChave].reduce((sum, r) => sum + r.valor, 0);
                }

                // Calcular despesas do mês
                let despesasMes = 0;
                if (dadosSistema.despesas[mesChave]) {
                    despesasMes = dadosSistema.despesas[mesChave].reduce((sum, d) => sum + d.valor, 0);
                }

                // Calcular faturas de cartão do mês
                const faturas = calcularFaturasCartoes(mesChave);
                const cartoesMes = Object.values(faturas).reduce((sum, fatura) => sum + fatura.total, 0);

                const saldoMensal = receitasMes - despesasMes - cartoesMes;
                saldoAcumulado += saldoMensal;

                tbody.innerHTML += `
                    <tr>
                        <td>${formatarMes(mes, parseInt(ano))}</td>
                        <td class="receita">${formatarMoeda(receitasMes)}</td>
                        <td class="despesa">${formatarMoeda(despesasMes)}</td>
                        <td class="cartao">${formatarMoeda(cartoesMes)}</td>
                        <td class="neutro">${formatarMoeda(saldoMensal)}</td>
                        <td class="neutro">${formatarMoeda(saldoAcumulado)}</td>
                    </tr>
                `;
            }
        }

        // LANÇAMENTO EM MASSA
        function mostrarLancamentoMassa(tipo) {
            if (!sistemaConfigurado) {
                alert('⚠️ Configure o sistema primeiro na aba Configuração');
                return;
            }

            document.getElementById('tituloModalMassa').textContent = 
                tipo === 'receita' ? '📊 Lançamento em Massa - Receitas' : '📊 Lançamento em Massa - Despesas';

            // Configurar select de tipos
            const selectTipo = document.getElementById('tipoMassa');
            selectTipo.innerHTML = '<option value="">Selecione um tipo</option>';
            
            const tipos = tipo === 'receita' ? dadosSistema.tiposReceita : dadosSistema.tiposDespesa;
            tipos.forEach(t => {
                selectTipo.innerHTML += `<option value="${t.id}">${t.nome}</option>`;
            });

            // Gerar checkboxes de meses
            const container = document.getElementById('checkboxesMeses');
            container.innerHTML = '';
            
            const config = dadosSistema.configuracao;
            const anoAtual = new Date().getFullYear();

            for (let ano = config.anoInicio; ano <= anoAtual + 2; ano++) {
                const mesInicial = (ano === config.anoInicio) ? config.mesInicio : 1;
                
                for (let mes = mesInicial; mes <= 12; mes++) {
                    const chave = chaveAnoMes(ano, mes);
                    const label = formatarMes(mes, ano);
                    
                    container.innerHTML += `
                        <label style="display: block; margin: 5px 0; cursor: pointer;">
                            <input type="checkbox" value="${chave}" style="margin-right: 8px;">
                            ${label}
                        </label>
                    `;
                }
            }

            // Armazenar tipo atual
            document.getElementById('modalMassa').setAttribute('data-tipo', tipo);
            document.getElementById('modalMassa').style.display = 'block';
        }

        function executarLancamentoMassa() {
            const tipo = document.getElementById('modalMassa').getAttribute('data-tipo');
            const tipoId = document.getElementById('tipoMassa').value;
            const valor = parseFloat(document.getElementById('valorMassa').value);
            
            if (!tipoId || !valor) {
                alert('⚠️ Preencha o tipo e valor');
                return;
            }

            // Coletar meses selecionados
            const checkboxes = document.querySelectorAll('#checkboxesMeses input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('⚠️ Selecione pelo menos um mês');
                return;
            }

            const mesesSelecionados = Array.from(checkboxes).map(cb => cb.value);
            
            if (!confirm(`⚠️ Confirma lançamento de ${formatarMoeda(valor)} em ${mesesSelecionados.length} meses?`)) {
                return;
            }

            // Buscar dados do tipo
            const tipos = tipo === 'receita' ? dadosSistema.tiposReceita : dadosSistema.tiposDespesa;
            const tipoObj = tipos.find(t => t.id === tipoId);
            
            // Fazer lançamentos
            mesesSelecionados.forEach(mesChave => {
                const novoItem = {
                    id: generateId(),
                    tipoId,
                    tipoNome: tipoObj.nome,
                    valor,
                    mesChave,
                    dataCriacao: new Date().toISOString()
                };

                const dados = tipo === 'receita' ? dadosSistema.receitas : dadosSistema.despesas;
                
                if (!dados[mesChave]) {
                    dados[mesChave] = [];
                }
                dados[mesChave].push(novoItem);
            });

            salvarDados();
            fecharModalMassa();
            
            if (tipo === 'receita') {
                atualizarListaReceitas();
            } else {
                atualizarListaDespesas();
            }

            alert(`✅ Lançamento em massa realizado! ${mesesSelecionados.length} registros criados.`);
        }

        function fecharModalMassa() {
            document.getElementById('modalMassa').style.display = 'none';
            document.getElementById('valorMassa').value = '';
            document.getElementById('tipoMassa').value = '';
            document.querySelectorAll('#checkboxesMeses input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        // BACKUP E EXPORTAÇÃO
        function exportarDados() {
            const dataExport = {
                ...dadosSistema,
                dataExportacao: new Date().toISOString(),
                versaoExportacao: "3.1"
            };

            const blob = new Blob([JSON.stringify(dataExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `sistema-financeiro-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            alert('✅ Dados exportados com sucesso!');
        }

        function importarDados(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('⚠️ Isso substituirá todos os dados atuais. Tem certeza?')) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dadosImportados = JSON.parse(e.target.result);
                    
                    // Validar estrutura básica
                    if (!dadosImportados.versao || !dadosImportados.configuracao) {
                        throw new Error('Arquivo inválido');
                    }

                    // Importar dados
                    dadosSistema = { ...dadosImportados };
                    sistemaConfigurado = !!dadosSistema.configuracao;
                    
                    salvarDados();
                    
                    alert('✅ Dados importados com sucesso! A página será recarregada.');
                    location.reload();
                    
                } catch (error) {
                    alert('❌ Erro ao importar dados. Verifique se o arquivo está correto.');
                }
            };
            reader.readAsText(file);
        }

        // PERSISTÊNCIA DE DADOS
        function salvarDados() {
            localStorage.setItem('sistemaFinanceiro', JSON.stringify(dadosSistema));
        }

        function carregarDados() {
            const dadosSalvos = localStorage.getItem('sistemaFinanceiro');
            if (dadosSalvos) {
                try {
                    dadosSistema = JSON.parse(dadosSalvos);
                    sistemaConfigurado = !!dadosSistema.configuracao;
                    
                    if (sistemaConfigurado) {
                        const config = dadosSistema.configuracao;
                        document.getElementById('configStatus').innerHTML = 
                            `<div class="alert alert-success">✅ Sistema configurado! Início: ${formatarMes(config.mesInicio, config.anoInicio)} | Saldo inicial: ${formatarMoeda(config.saldoInicial)}</div>`;
                        
                        // Atualizar campos de configuração
                        document.getElementById('mesInicio').value = config.mesInicio;
                        document.getElementById('anoInicio').value = config.anoInicio;
                        document.getElementById('saldoInicial').value = config.saldoInicial;
                        
                        gerarOpcoesMeses();
                        atualizarSelectsTipos();
                        atualizarSelectCartoes();
                    }
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                }
            }
        }

        // INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
            
            // Definir data padrão para compra como hoje
            document.getElementById('dataCompra').value = new Date().toISOString().split('T')[0];
            
            // Configurar fechamento de modais ao clicar fora
            window.onclick = function(event) {
                const modalCompras = document.getElementById('modalCompras');
                const modalMassa = document.getElementById('modalMassa');
                
                if (event.target === modalCompras) {
                    fecharModalCompras();
                }
                if (event.target === modalMassa) {
                    fecharModalMassa();
                }
            };
        });

        // Auto-save a cada 30 segundos
        setInterval(salvarDados, 30000);
    </script>
</body>
</html>
